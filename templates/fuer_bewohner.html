<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Für Bewohner | OpenLEG</title>
  {% include 'partials/tailwind_brand.html' %}
</head>
<body class="bg-[#f6f4ef] text-ink">
  {% include 'partials/site_nav.html' %}

  <div class="max-w-5xl mx-auto px-4 pt-10">
    <div class="overflow-hidden rounded-2xl border border-slate-200 shadow-lg">
      <img src="/static/images/subpages/how-it-works.png" alt="OpenLEG für Bewohner" class="w-full aspect-[3/1] object-cover" loading="lazy">
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 py-12">
    <header class="text-center mb-10">
      <h1 class="text-4xl font-bold mb-2">OpenLEG für Bewohner</h1>
      <p class="text-ink-muted max-w-3xl mx-auto">
        Sie prüfen Ihre Adresse, finden Nachbarn mit Solarstrom und treten einer lokalen Stromgemeinschaft bei.
        OpenLEG koordiniert den gesamten Prozess: vom ersten Check bis zur laufenden LEG.
      </p>
    </header>

    <div class="grid md:grid-cols-2 gap-6">
      <section class="bg-white rounded-xl shadow-md p-6 border-t-4 border-brand">
        <h2 class="text-xl font-bold mb-2">Eigentümer mit PV</h2>
        <p class="text-sm text-ink-muted mb-4">
          Sie erzeugen Solarstrom und wollen ihn lokal teilen.
          OpenLEG findet passende Haushalte im zulässigen Radius,
          erstellt Verträge und Anmeldeunterlagen,
          reicht alles beim Netzbetreiber ein.
        </p>
        <ul class="text-sm space-y-2 text-ink-muted">
          <li>&#10003; Adress- und Radiusprüfung nach LEG-Regeln</li>
          <li>&#10003; Teilnehmer-Matching mit Einwilligungslogik</li>
          <li>&#10003; Vertrags- und Anmeldepaket automatisch erzeugt</li>
          <li>&#10003; Klarer Status bis zur Inbetriebnahme</li>
        </ul>
      </section>

      <section class="bg-white rounded-xl shadow-md p-6 border-t-4 border-ink/20">
        <h2 class="text-xl font-bold mb-2">Mieter und Haushalte ohne eigene PV</h2>
        <p class="text-sm text-ink-muted mb-4">
          Sie stärken die Verhandlungsposition Ihrer LEG, beziehen lokalen Strom
          und brauchen keinen Technikaufwand. Registrieren Sie sich, sehen Sie den Fortschritt
          in Ihrer Nachbarschaft und treten Sie bei, sobald eine Gemeinschaft entsteht.
        </p>
        <ul class="text-sm space-y-2 text-ink-muted">
          <li>&#10003; Niedrige Einstiegshürde ohne Technikaufwand</li>
          <li>&#10003; Transparente Kommunikation mit Initiatoren</li>
          <li>&#10003; Nachvollziehbarer Prozess statt Einzelabsprachen</li>
          <li>&#10003; Datenschutzkonforme Teilnahmeverwaltung</li>
        </ul>
      </section>
    </div>

    <section class="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-6">
      <h2 class="text-2xl font-bold mb-3">Ehrlich zu Einsparungen</h2>
      <div class="text-ink-muted space-y-2">
        <p>
          Noch existieren keine Betriebsdaten aus realen LEGs.
          OpenLEG zeigt transparente Hochrechnungen auf Basis öffentlicher ElCom-Tarife, keine Versprechen.
        </p>
        <p>Der Plattform-Kern ist kostenlos und Open Source. Keine Registrierungsgebühr, keine Paywall im Grundprozess.</p>
        <p>Ihre Daten bleiben im LEG-Kontext. Kein Datenverkauf an Dritte oder Energievertrieb.</p>
      </div>
    </section>

    <section class="mt-6 bg-white rounded-xl border border-slate-200 p-6">
      <h2 class="text-2xl font-bold mb-3">Das eigentliche Problem: Koordination</h2>
      <p class="text-ink-muted">
        Die Herausforderung: genug Nachbarn zusammenbringen, Verträge klären, den Netzbetreiber korrekt informieren.
        OpenLEG koordiniert genau das. Statt Chats, Tabellen und manueller Dokumentsuche erhalten Sie einen klaren Ablauf
        mit den nächsten Schritten, Pflichtdaten und Vorlagen für Vereinbarung, Teilnehmerverträge und Netzbetreiber-Anmeldung.
      </p>
    </section>

    <section class="mt-6 bg-white rounded-xl border border-slate-200 p-6">
      <h2 class="text-2xl font-bold mb-3">Was Sie konkret bekommen</h2>
      <div class="grid md:grid-cols-2 gap-6 text-ink-muted">
        <div>
          <h3 class="font-semibold text-ink mb-1">Von der Idee zur Anmeldung</h3>
          <p>
            Sie durchlaufen einen klaren Prozess: Adresse prüfen, Nachbarn finden, Verträge erstellen,
            Netzbetreiber informieren. OpenLEG liefert Vorlagen und Checklisten für jeden Schritt.
          </p>
        </div>
        <div>
          <h3 class="font-semibold text-ink mb-1">Betrieb mit Überblick</h3>
          <p>
            Nach der Gründung behalten Sie Verbrauch, Rollen und Status pro Teilnehmer im Blick.
            So bleibt die Gemeinschaft organisatorisch stabil und skalierbar.
          </p>
        </div>
      </div>
    </section>

    <!-- Embedded Registration Form -->
    <section class="mt-10 bg-white rounded-xl shadow-md p-6">
      <h2 class="text-2xl font-bold mb-2 text-center">Jetzt Adresse prüfen und registrieren</h2>
      <p class="text-ink-muted text-center mb-6">
        {% if user_count %}Bereits {{ user_count }} Haushalte registriert.{% endif %}
      </p>

      <div class="max-w-md mx-auto">
        <div id="step-address">
          <label class="block text-sm font-medium mb-1">Ihre Adresse</label>
          <input type="text" id="address-input" placeholder="Strasse, PLZ Ort" class="w-full border rounded-lg px-3 py-2 mb-1 focus:ring-2 focus:ring-brand focus:outline-none" autocomplete="off">
          <div id="suggestions" class="bg-white border rounded-lg max-h-48 overflow-y-auto hidden"></div>
          <div id="profile-summary" class="text-sm text-ink-muted mt-2 hidden"></div>
          <button id="btn-check" class="w-full bg-brand text-white py-2 rounded-lg mt-3 font-medium hover:bg-brand-dark disabled:opacity-50" disabled>Adresse prüfen</button>
        </div>

        <div id="step-register" class="hidden">
          <div id="match-info" class="bg-indigo-50 p-3 rounded-lg mb-3 text-sm"></div>
          <label class="block text-sm font-medium mb-1">E-Mail</label>
          <input type="email" id="email-input" placeholder="ihre@email.ch" class="w-full border rounded-lg px-3 py-2 mb-2 focus:ring-2 focus:ring-brand focus:outline-none">
          <label class="block text-sm font-medium mb-1">Telefon (optional)</label>
          <input type="tel" id="phone-input" placeholder="+41 79 ..." class="w-full border rounded-lg px-3 py-2 mb-3 focus:ring-2 focus:ring-brand focus:outline-none">
          <div class="space-y-2 mb-4 text-sm">
            <label class="flex items-start gap-2"><input type="checkbox" id="consent-neighbors" class="mt-1"> Ich möchte, dass interessierte Nachbarn in meiner Nähe mich kontaktieren können.</label>
            <label class="flex items-start gap-2"><input type="checkbox" id="consent-utility" class="mt-1"> Meine Daten dürfen für die LEG-Anmeldung beim Netzbetreiber verwendet werden.</label>
            <label class="flex items-start gap-2"><input type="checkbox" id="consent-updates"> Ich möchte Updates per E-Mail erhalten.</label>
          </div>
          <p class="text-xs text-ink-muted mb-3">Ihre Daten werden nicht verkauft und nicht an Dritte weitergegeben. Sie können jederzeit alles löschen.</p>
          <button id="btn-register" class="w-full bg-amber-500 text-ink py-2 rounded-lg font-semibold hover:bg-amber-400">Jetzt registrieren</button>
        </div>

        <div id="step-success" class="hidden text-center py-6">
          <div class="text-4xl mb-3">&#9889;</div>
          <h3 class="text-lg font-semibold mb-2">Registrierung erfolgreich!</h3>
          <p class="text-ink-muted mb-4">Sie erhalten eine Bestätigung per E-Mail.</p>
          <div id="referral-link-box" class="bg-gray-50 p-3 rounded-lg text-sm hidden">
            <p class="font-medium mb-1">Teilen Sie Ihren Einladungslink:</p>
            <input type="text" id="referral-link" class="w-full border rounded px-2 py-1 text-xs" readonly>
          </div>
        </div>

        <div id="form-error" class="text-red-600 text-sm mt-2 hidden"></div>
      </div>
    </section>

    <div class="mt-10 flex flex-col sm:flex-row gap-3">
      <a href="/fuer-gemeinden" class="border border-ink/20 text-ink px-6 py-3 rounded-lg font-semibold hover:bg-white text-center">Angebot für Gemeinden</a>
    </div>
  </main>

  {% include 'partials/site_footer.html' %}

  <script>
  let selectedProfile = null;
  let addressTimeout = null;
  const params = new URLSearchParams(window.location.search);
  const referralCode = params.get('ref') || '';

  const addressInput = document.getElementById('address-input');
  const suggestionsDiv = document.getElementById('suggestions');
  const btnCheck = document.getElementById('btn-check');

  addressInput.addEventListener('input', function() {
    clearTimeout(addressTimeout);
    const q = this.value.trim();
    if (q.length < 3) { suggestionsDiv.classList.add('hidden'); return; }
    addressTimeout = setTimeout(async () => {
      const res = await fetch(`/api/suggest_addresses?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (data.suggestions && data.suggestions.length > 0) {
        suggestionsDiv.innerHTML = data.suggestions.map(s =>
          `<div class="px-3 py-2 hover:bg-indigo-50 cursor-pointer text-sm border-b" data-lat="${s.lat}" data-lon="${s.lon}" data-plz="${s.plz}" data-label="${s.label}">${s.label}</div>`
        ).join('');
        suggestionsDiv.classList.remove('hidden');
        suggestionsDiv.querySelectorAll('div').forEach(el => {
          el.addEventListener('click', function() {
            addressInput.value = this.dataset.label;
            suggestionsDiv.classList.add('hidden');
            btnCheck.disabled = false;
          });
        });
      } else {
        suggestionsDiv.classList.add('hidden');
      }
    }, 300);
  });

  btnCheck.addEventListener('click', async function() {
    this.disabled = true;
    this.textContent = 'Prüfe...';
    document.getElementById('form-error').classList.add('hidden');
    try {
      const res = await fetch('/api/check_potential', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({address: addressInput.value})
      });
      const data = await res.json();
      if (data.error) {
        document.getElementById('form-error').textContent = data.error;
        document.getElementById('form-error').classList.remove('hidden');
        this.disabled = false;
        this.textContent = 'Adresse prüfen';
        return;
      }
      selectedProfile = data.profile_summary;
      const matchInfo = document.getElementById('match-info');
      if (data.potential) {
        const ci = data.cluster_info;
        matchInfo.innerHTML = `<strong>${ci.num_members} Nachbarn gefunden!</strong> Autarkie-Potenzial: ${ci.autarky_percent.toFixed(0)}%`;
      } else {
        matchInfo.innerHTML = '<strong>Noch keine Nachbarn gefunden.</strong> Sie können trotzdem registrieren.';
      }
      document.getElementById('step-address').classList.add('hidden');
      document.getElementById('step-register').classList.remove('hidden');
    } catch(e) {
      document.getElementById('form-error').textContent = 'Netzwerkfehler. Bitte erneut versuchen.';
      document.getElementById('form-error').classList.remove('hidden');
      this.disabled = false;
      this.textContent = 'Adresse prüfen';
    }
  });

  document.getElementById('btn-register').addEventListener('click', async function() {
    const email = document.getElementById('email-input').value;
    const phone = document.getElementById('phone-input').value;
    const cn = document.getElementById('consent-neighbors').checked;
    const cu = document.getElementById('consent-utility').checked;
    const co = document.getElementById('consent-updates').checked;
    if (!email) {
      document.getElementById('form-error').textContent = 'Bitte E-Mail angeben.';
      document.getElementById('form-error').classList.remove('hidden');
      return;
    }
    try {
      const res = await fetch('/api/register_anonymous', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          email, phone, profile: selectedProfile,
          referral_code: referralCode,
          consents: {share_with_neighbors: cn, share_with_utility: cu, updates_opt_in: co}
        })
      });
      const data = await res.json();
      if (data.success) {
        document.getElementById('step-register').classList.add('hidden');
        document.getElementById('step-success').classList.remove('hidden');
        if (data.referral_link) {
          document.getElementById('referral-link').value = data.referral_link;
          document.getElementById('referral-link-box').classList.remove('hidden');
        }
      } else {
        document.getElementById('form-error').textContent = data.error || 'Registrierung fehlgeschlagen.';
        document.getElementById('form-error').classList.remove('hidden');
      }
    } catch(e) {
      document.getElementById('form-error').textContent = 'Netzwerkfehler.';
      document.getElementById('form-error').classList.remove('hidden');
    }
  });
  </script>
</body>
</html>
