<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | OpenLEG Utility Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-indigo-600">OpenLEG</a>
            <div class="flex items-center space-x-4 text-sm">
                <span class="text-gray-600">{{ client.company_name }}</span>
                <span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded text-xs font-medium uppercase">{{ client.tier }}</span>
                <a href="/utility/logout" class="text-gray-500 hover:text-red-600">Abmelden</a>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-3xl font-bold">Utility Dashboard</h1>
                <p class="text-gray-600">{{ client.company_name }}{% if client.kanton %} ({{ client.kanton }}){% endif %}</p>
            </div>
            <span class="px-3 py-1 rounded-full text-sm font-medium
                {% if client.status == 'active' %}bg-green-100 text-green-800
                {% elif client.status == 'trial' %}bg-amber-100 text-amber-800
                {% else %}bg-gray-100 text-gray-800{% endif %}">
                {{ client.status|capitalize }}
            </span>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow p-5">
                <p class="text-sm text-gray-500 mb-1">Status</p>
                <p class="text-2xl font-bold text-indigo-600">{{ client.status|capitalize }}</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5">
                <p class="text-sm text-gray-500 mb-1">Tier</p>
                <p class="text-2xl font-bold">{{ client.tier|capitalize }}</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5">
                <p class="text-sm text-gray-500 mb-1">VNB</p>
                <p class="text-lg font-semibold truncate">{{ client.vnb_name or 'Nicht angegeben' }}</p>
            </div>
            <div class="bg-white rounded-lg shadow p-5">
                <p class="text-sm text-gray-500 mb-1">Einwohner</p>
                <p class="text-2xl font-bold">{{ '{:,}'.format(client.population) if client.population else 'N/A' }}</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- API Key -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-3">API-Zugang</h2>
                {% if client.api_key_hash %}
                <p class="text-sm text-green-600 mb-3">&#10003; API-Schluessel aktiv</p>
                <p class="text-xs text-gray-500 mb-3">Nutzen Sie den Header <code class="bg-gray-100 px-1 rounded">X-API-Key</code> fuer B2B API Anfragen.</p>
                {% else %}
                <p class="text-sm text-gray-500 mb-3">Noch kein API-Schluessel generiert.</p>
                {% endif %}
                <button id="gen-key-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-indigo-700">
                    {% if client.api_key_hash %}Neuen Schluessel generieren{% else %}API-Schluessel generieren{% endif %}
                </button>
                <div id="api-key-result" class="mt-3 hidden">
                    <p class="text-sm text-amber-700 mb-1">Bitte sicher speichern, wird nur einmal angezeigt:</p>
                    <code id="api-key-value" class="block bg-gray-100 p-2 rounded text-xs break-all"></code>
                </div>
            </div>

            <!-- Onboarding Progress -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-bold mb-3">Onboarding</h2>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full bg-green-500 text-white flex items-center justify-center text-xs mr-3">&#10003;</span>
                        <span class="text-sm">Registrierung abgeschlossen</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full {{ 'bg-green-500 text-white' if client.api_key_hash else 'bg-gray-200 text-gray-500' }} flex items-center justify-center text-xs mr-3">
                            {% if client.api_key_hash %}&#10003;{% else %}2{% endif %}
                        </span>
                        <span class="text-sm">API-Schluessel generieren</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-xs mr-3">3</span>
                        <span class="text-sm">White-Label Branding konfigurieren</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-6 h-6 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-xs mr-3">4</span>
                        <span class="text-sm">Erste LEG-Gruendung starten</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Info -->
        <div class="bg-white rounded-lg shadow p-6 mb-8">
            <h2 class="text-lg font-bold mb-4">Kontoinformationen</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <p class="text-gray-500">Firma</p>
                    <p class="font-medium">{{ client.company_name }}</p>
                </div>
                <div>
                    <p class="text-gray-500">Kontaktperson</p>
                    <p class="font-medium">{{ client.contact_name or 'Nicht angegeben' }}</p>
                </div>
                <div>
                    <p class="text-gray-500">E-Mail</p>
                    <p class="font-medium">{{ client.contact_email }}</p>
                </div>
                <div>
                    <p class="text-gray-500">Telefon</p>
                    <p class="font-medium">{{ client.contact_phone or 'Nicht angegeben' }}</p>
                </div>
                <div>
                    <p class="text-gray-500">Registriert am</p>
                    <p class="font-medium">{{ client.created_at.strftime('%d.%m.%Y') if client.created_at else 'N/A' }}</p>
                </div>
                <div>
                    <p class="text-gray-500">Letzter Login</p>
                    <p class="font-medium">{{ client.last_login_at.strftime('%d.%m.%Y %H:%M') if client.last_login_at else 'Erster Login' }}</p>
                </div>
            </div>
        </div>

        <!-- API Documentation Link -->
        <div class="bg-indigo-50 rounded-lg p-6 text-center">
            <h3 class="text-lg font-bold mb-2">API Dokumentation</h3>
            <p class="text-gray-600 text-sm mb-4">Integrieren Sie LEG-Daten in Ihre bestehenden Systeme.</p>
            <a href="/api/v1/docs" class="inline-block bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">API Docs oeffnen</a>
        </div>
    </div>

    <script>
    document.getElementById('gen-key-btn').addEventListener('click', async function() {
        if (!confirm('Neuen API-Schluessel generieren? Der alte wird ungueltig.')) return;
        try {
            const res = await fetch('/utility/api-key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await res.json();
            if (data.success) {
                document.getElementById('api-key-value').textContent = data.api_key;
                document.getElementById('api-key-result').classList.remove('hidden');
            } else {
                alert(data.error || 'Fehler bei der Schluesselgenerierung.');
            }
        } catch(e) {
            alert('Netzwerkfehler.');
        }
    });
    </script>
</body>
</html>
