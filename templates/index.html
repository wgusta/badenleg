<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLEG – Die Intelligenz hinter dem Netz | LEG-Plattform für Schweizer Gemeinden</title>
    <meta name="description" content="OpenLEG hilft Schweizer Gemeinden, Lokale Elektrizitätsgemeinschaften (LEG) zu gründen und zu optimieren. Smart Meter Daten, KI-gestützte Analyse, B2B Insights.">
    <link rel="canonical" href="{{ site_url }}/">
    <meta property="og:title" content="OpenLEG – Die Intelligenz hinter dem Netz">
    <meta property="og:description" content="LEG-Plattform für Schweizer Gemeinden. Smart Meter Intelligence für Energieversorger.">
    <meta property="og:url" content="{{ site_url }}/">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {% if ga4_id %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga4_id }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '{{ ga4_id }}');
    </script>
    {% endif %}
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { DEFAULT: '#6366f1', light: '#818cf8', dark: '#4f46e5' },
                        accent: '#f59e0b',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Nav -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-brand">OpenLEG</a>
            <div class="hidden md:flex space-x-6 text-sm">
                <a href="#wie-es-funktioniert" class="hover:text-brand">So funktioniert's</a>
                <a href="#registrieren" class="hover:text-brand">Registrieren</a>
                <a href="/gemeinde/onboarding" class="hover:text-brand">Für Gemeinden</a>
                <a href="/how-it-works" class="hover:text-brand">Mehr erfahren</a>
            </div>
            <a href="/gemeinde/onboarding" class="bg-brand text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-brand-dark">Gemeinde anmelden</a>
        </div>
    </nav>

    <!-- Hero -->
    <section class="bg-gradient-to-br from-indigo-600 to-indigo-800 text-white py-20">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-4">OpenLEG</h1>
            <p class="text-xl md:text-2xl text-indigo-200 mb-2">Die Intelligenz hinter dem Netz.</p>
            <p class="text-lg text-indigo-300 mb-8 max-w-2xl mx-auto">Die Plattform für Lokale Elektrizitätsgemeinschaften im Kanton {{ kanton }}. Gemeinden gründen LEGs, Bewohner teilen Strom, Energieversorger gewinnen Insights.</p>
            {% if user_count > 0 %}
            <p class="text-indigo-200 mb-6">Bereits <strong class="text-white text-xl">{{ user_count }}</strong> Haushalte registriert</p>
            {% endif %}
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="#registrieren" class="bg-amber-500 text-gray-900 px-8 py-3 rounded-lg font-semibold hover:bg-amber-400 text-lg">Jetzt Adresse prüfen</a>
                <a href="/gemeinde/onboarding" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-indigo-700 text-lg">Gemeinde registrieren</a>
            </div>
        </div>
    </section>

    <!-- How it works -->
    <section id="wie-es-funktioniert" class="py-16 bg-white">
        <div class="max-w-5xl mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">So funktioniert OpenLEG</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="text-center p-6">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-brand">1</span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Gemeinde registriert sich</h3>
                    <p class="text-gray-600">Ihre Gemeinde meldet sich an und erhält eine eigene OpenLEG-Instanz mit LEG-Dashboard und KPIs.</p>
                </div>
                <div class="text-center p-6">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-brand">2</span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Bewohner treten bei</h3>
                    <p class="text-gray-600">Hauseigentümer registrieren sich, laden Smart-Meter-Daten hoch und finden LEG-Nachbarn.</p>
                </div>
                <div class="text-center p-6">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl font-bold text-brand">3</span>
                    </div>
                    <h3 class="font-semibold text-lg mb-2">Intelligenz entsteht</h3>
                    <p class="text-gray-600">Aus aggregierten Daten entstehen Insights: Lastprofile, Solar-Index, Flexibilitätspotenzial.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Map + Registration -->
    <section id="registrieren" class="py-16 bg-gray-50">
        <div class="max-w-5xl mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8">Adresse prüfen &amp; registrieren</h2>
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Map -->
                <div>
                    <div id="map" class="w-full h-96 rounded-lg shadow-md z-0"></div>
                    <p class="text-xs text-gray-500 mt-2">Registrierte Haushalte (anonymisiert)</p>
                </div>
                <!-- Form -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div id="step-address">
                        <label class="block text-sm font-medium mb-1">Ihre Adresse</label>
                        <input type="text" id="address-input" placeholder="Strasse, PLZ Ort" class="w-full border rounded-lg px-3 py-2 mb-1 focus:ring-2 focus:ring-brand focus:outline-none" autocomplete="off">
                        <div id="suggestions" class="bg-white border rounded-lg max-h-48 overflow-y-auto hidden"></div>
                        <div id="profile-summary" class="text-sm text-gray-600 mt-2 hidden"></div>
                        <button id="btn-check" class="w-full bg-brand text-white py-2 rounded-lg mt-3 font-medium hover:bg-brand-dark disabled:opacity-50" disabled>Adresse prüfen</button>
                    </div>
                    <div id="step-register" class="hidden">
                        <div id="match-info" class="bg-indigo-50 p-3 rounded-lg mb-3 text-sm"></div>
                        <label class="block text-sm font-medium mb-1">E-Mail</label>
                        <input type="email" id="email-input" placeholder="ihre@email.ch" class="w-full border rounded-lg px-3 py-2 mb-2 focus:ring-2 focus:ring-brand focus:outline-none">
                        <label class="block text-sm font-medium mb-1">Telefon (optional)</label>
                        <input type="tel" id="phone-input" placeholder="+41 79 ..." class="w-full border rounded-lg px-3 py-2 mb-3 focus:ring-2 focus:ring-brand focus:outline-none">
                        <div class="space-y-2 mb-4 text-sm">
                            <label class="flex items-start gap-2"><input type="checkbox" id="consent-neighbors" class="mt-1"> Ich stimme zu, meine Kontaktdaten mit LEG-Nachbarn zu teilen.</label>
                            <label class="flex items-start gap-2"><input type="checkbox" id="consent-utility" class="mt-1"> Ich stimme zu, meine Daten für LEG-Anfragen an den Netzbetreiber weiterzugeben.</label>
                            <label class="flex items-start gap-2"><input type="checkbox" id="consent-updates"> Ich möchte Updates per E-Mail erhalten.</label>
                        </div>
                        <button id="btn-register" class="w-full bg-amber-500 text-gray-900 py-2 rounded-lg font-semibold hover:bg-amber-400">Jetzt registrieren</button>
                    </div>
                    <div id="step-success" class="hidden text-center py-6">
                        <div class="text-4xl mb-3">&#9889;</div>
                        <h3 class="text-lg font-semibold mb-2">Registrierung erfolgreich!</h3>
                        <p class="text-gray-600 mb-4">Sie erhalten eine Bestätigung per E-Mail.</p>
                        <div id="referral-link-box" class="bg-gray-50 p-3 rounded-lg text-sm hidden">
                            <p class="font-medium mb-1">Teilen Sie Ihren Einladungslink:</p>
                            <input type="text" id="referral-link" class="w-full border rounded px-2 py-1 text-xs" readonly>
                        </div>
                    </div>
                    <div id="form-error" class="text-red-600 text-sm mt-2 hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Value props -->
    <section class="py-16 bg-white">
        <div class="max-w-5xl mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div class="border rounded-lg p-6">
                    <h3 class="font-semibold text-lg mb-2 text-brand">Für Gemeinden</h3>
                    <ul class="text-gray-600 space-y-1 text-sm">
                        <li>&#10003; LEG-Gründung digital begleiten</li>
                        <li>&#10003; Eigenes Dashboard mit KPIs</li>
                        <li>&#10003; White-Label unter gemeinde.openleg.ch</li>
                        <li>&#10003; Kostenloser Einstieg</li>
                    </ul>
                </div>
                <div class="border rounded-lg p-6">
                    <h3 class="font-semibold text-lg mb-2 text-brand">Für Bewohner</h3>
                    <ul class="text-gray-600 space-y-1 text-sm">
                        <li>&#10003; LEG-Nachbarn in der Umgebung finden</li>
                        <li>&#10003; Smart-Meter-Daten hochladen</li>
                        <li>&#10003; Ersparnisse berechnen</li>
                        <li>&#10003; Datenkontrolle in 3 Stufen</li>
                    </ul>
                </div>
                <div class="border rounded-lg p-6">
                    <h3 class="font-semibold text-lg mb-2 text-brand">Für Energieversorger</h3>
                    <ul class="text-gray-600 space-y-1 text-sm">
                        <li>&#10003; Lastprofile nach PLZ</li>
                        <li>&#10003; Solar-Adoptions-Index</li>
                        <li>&#10003; Flexibilitätspotenzial</li>
                        <li>&#10003; API-Zugang (insights.openleg.ch)</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 py-8">
        <div class="max-w-5xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <span class="text-white font-bold text-lg">OpenLEG</span>
                <span class="text-sm ml-2">Die Intelligenz hinter dem Netz.</span>
            </div>
            <div class="flex gap-6 text-sm">
                <a href="/impressum" class="hover:text-white">Impressum</a>
                <a href="/datenschutz" class="hover:text-white">Datenschutz</a>
                <a href="/how-it-works" class="hover:text-white">So funktioniert's</a>
                <a href="/pricing" class="hover:text-white">Preise</a>
            </div>
        </div>
    </footer>

    <script>
    // Map
    const map = L.map('map').setView([{{ map_center_lat }}, {{ map_center_lon }}], {{ map_zoom }});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let selectedProfile = null;
    let addressTimeout = null;

    // Address autocomplete
    const addressInput = document.getElementById('address-input');
    const suggestionsDiv = document.getElementById('suggestions');
    const btnCheck = document.getElementById('btn-check');

    addressInput.addEventListener('input', function() {
        clearTimeout(addressTimeout);
        const q = this.value.trim();
        if (q.length < 3) { suggestionsDiv.classList.add('hidden'); return; }
        addressTimeout = setTimeout(async () => {
            const res = await fetch(`/api/suggest_addresses?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsDiv.innerHTML = data.suggestions.map(s =>
                    `<div class="px-3 py-2 hover:bg-indigo-50 cursor-pointer text-sm border-b" data-lat="${s.lat}" data-lon="${s.lon}" data-plz="${s.plz}" data-label="${s.label}">${s.label}</div>`
                ).join('');
                suggestionsDiv.classList.remove('hidden');
                suggestionsDiv.querySelectorAll('div').forEach(el => {
                    el.addEventListener('click', function() {
                        addressInput.value = this.dataset.label;
                        suggestionsDiv.classList.add('hidden');
                        btnCheck.disabled = false;
                    });
                });
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        }, 300);
    });

    // Check potential
    btnCheck.addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = 'Prüfe...';
        document.getElementById('form-error').classList.add('hidden');
        try {
            const res = await fetch('/api/check_potential', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({address: addressInput.value})
            });
            const data = await res.json();
            if (data.error) {
                document.getElementById('form-error').textContent = data.error;
                document.getElementById('form-error').classList.remove('hidden');
                this.disabled = false;
                this.textContent = 'Adresse prüfen';
                return;
            }
            selectedProfile = data.profile_summary;
            const matchInfo = document.getElementById('match-info');
            if (data.potential) {
                const ci = data.cluster_info;
                matchInfo.innerHTML = `<strong>${ci.num_members} Nachbarn gefunden!</strong> Autarkie-Potenzial: ${ci.autarky_percent.toFixed(0)}%`;
                if (selectedProfile && selectedProfile.lat) {
                    L.marker([selectedProfile.lat, selectedProfile.lon]).addTo(map).bindPopup('Ihr Standort');
                    map.setView([selectedProfile.lat, selectedProfile.lon], 16);
                }
            } else {
                matchInfo.innerHTML = 'Noch keine Nachbarn in der Nähe. Seien Sie der Erste in Ihrer Zone!';
                if (selectedProfile && selectedProfile.lat) {
                    L.marker([selectedProfile.lat, selectedProfile.lon]).addTo(map).bindPopup('Ihr Standort');
                    map.setView([selectedProfile.lat, selectedProfile.lon], 15);
                }
            }
            document.getElementById('step-address').classList.add('hidden');
            document.getElementById('step-register').classList.remove('hidden');
        } catch (e) {
            document.getElementById('form-error').textContent = 'Fehler bei der Adressprüfung.';
            document.getElementById('form-error').classList.remove('hidden');
        }
        this.disabled = false;
        this.textContent = 'Adresse prüfen';
    });

    // Register
    document.getElementById('btn-register').addEventListener('click', async function() {
        const email = document.getElementById('email-input').value.trim();
        const phone = document.getElementById('phone-input').value.trim();
        const cn = document.getElementById('consent-neighbors').checked;
        const cu = document.getElementById('consent-utility').checked;
        const co = document.getElementById('consent-updates').checked;
        if (!email) { alert('Bitte E-Mail eingeben.'); return; }
        if (!cn || !cu) { alert('Bitte stimmen Sie beiden Datenweitergaben zu.'); return; }
        this.disabled = true;
        this.textContent = 'Registriere...';
        try {
            const res = await fetch('/api/register_anonymous', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: email, phone: phone, profile: selectedProfile,
                    referral_code: '{{ referral_code }}',
                    consents: {share_with_neighbors: cn, share_with_utility: cu, updates_opt_in: co}
                })
            });
            const data = await res.json();
            if (data.error) {
                document.getElementById('form-error').textContent = data.error;
                document.getElementById('form-error').classList.remove('hidden');
            } else {
                document.getElementById('step-register').classList.add('hidden');
                document.getElementById('step-success').classList.remove('hidden');
                if (data.referral_link) {
                    document.getElementById('referral-link').value = data.referral_link;
                    document.getElementById('referral-link-box').classList.remove('hidden');
                }
                // Update map
                if (data.buildings) {
                    data.buildings.forEach(b => {
                        L.circleMarker([b.lat, b.lon], {radius: 5, color: b.type === 'registered' ? '#6366f1' : '#94a3b8', fillOpacity: 0.6}).addTo(map);
                    });
                }
            }
        } catch(e) {
            document.getElementById('form-error').textContent = 'Registrierung fehlgeschlagen.';
            document.getElementById('form-error').classList.remove('hidden');
        }
        this.disabled = false;
        this.textContent = 'Jetzt registrieren';
    });

    // Load existing buildings
    fetch('/api/get_all_buildings').then(r => r.json()).then(data => {
        if (data.buildings) {
            data.buildings.forEach(b => {
                L.circleMarker([b.lat, b.lon], {radius: 4, color: b.type === 'registered' ? '#6366f1' : '#94a3b8', fillOpacity: 0.5}).addTo(map);
            });
        }
    });
    </script>
</body>
</html>
