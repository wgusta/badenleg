<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenLEG: Freie Infrastruktur für Schweizer Stromgemeinschaften</title>
  <meta name="description" content="OpenLEG ist die kostenlose Open Source Plattform für Lokale Elektrizitätsgemeinschaften (LEG) in der Schweiz. Nachbarn finden, Stromgemeinschaft gründen, Netzgebühren sparen.">
  <link rel="canonical" href="{{ site_url }}/">
  <meta property="og:title" content="OpenLEG: Freie Infrastruktur für Schweizer Stromgemeinschaften">
  <meta property="og:description" content="Kostenlos, Open Source, gehostet in der Schweiz. Gründen Sie Ihre lokale Stromgemeinschaft und sparen Sie bis 40% auf Netzgebühren.">
  <meta property="og:image" content="{{ site_url }}/static/images/og-image.png">
  <meta property="og:url" content="{{ site_url }}/">
  {% include 'partials/tailwind_brand.html' %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  {% if ga4_id %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga4_id }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '{{ ga4_id }}');
  </script>
  {% endif %}
</head>
<body class="bg-[#f6f4ef] text-ink">
  {% include 'partials/site_nav.html' %}

  <!-- Hero -->
  <section class="relative overflow-hidden">
    <div class="absolute inset-0 bg-[linear-gradient(90deg,rgba(15,23,42,0.06)_1px,transparent_1px),linear-gradient(0deg,rgba(15,23,42,0.06)_1px,transparent_1px)] bg-[size:42px_42px]"></div>
    <div class="absolute inset-0 bg-gradient-to-br from-white/80 via-transparent to-amber-50/70"></div>
    <div class="relative max-w-6xl mx-auto px-4 py-16 md:py-20 grid md:grid-cols-2 gap-10 items-center">
      <div>
        <div class="inline-flex items-center rounded-full border border-slate-300/60 bg-white/70 p-1 text-sm shadow-sm" role="tablist" aria-label="Zielgruppe">
          <button class="px-4 py-2 rounded-full" data-seg-tab="bewohner" role="tab" aria-selected="true">Bewohner</button>
          <button class="px-4 py-2 rounded-full" data-seg-tab="gemeinde" role="tab" aria-selected="false">Gemeinde</button>
        </div>

        <div class="mt-6" aria-live="polite">
          <div data-seg-panel="bewohner">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Ihr Strom. Ihre Nachbarn. Ihre Gemeinschaft.</h1>
            <p class="mt-4 text-lg text-ink-muted max-w-xl">Gründen Sie eine lokale Stromgemeinschaft (LEG) und sparen Sie bis 40% auf Netzgebühren. Kostenlos, Open Source, Ihre Daten bleiben bei Ihnen.</p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
              <a href="#registrieren" class="bg-brand text-white px-6 py-3 rounded-lg font-semibold hover:bg-brand-dark text-center">Adresse prüfen</a>
              <a href="/how-it-works" class="border border-ink/20 text-ink px-6 py-3 rounded-lg font-semibold hover:bg-white text-center">So funktioniert's</a>
            </div>
            <div class="mt-6 flex flex-wrap gap-2 text-xs">
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Kostenlos, für immer</span>
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Open Source</span>
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Ihre Daten bleiben bei Ihnen</span>
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Gehostet in der Schweiz</span>
            </div>
          </div>

          <div data-seg-panel="gemeinde" class="hidden">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight">Ihre Gemeinde ermöglicht die Energiewende.</h1>
            <p class="mt-4 text-lg text-ink-muted max-w-xl">Eigene Seite für Ihre Gemeinde, Bewohner finden Nachbarn, Stromgemeinschaften entstehen. Kostenlos, kein IT Projekt.</p>
            <div class="mt-6 flex flex-col sm:flex-row gap-3">
              <a href="/gemeinde/onboarding" class="bg-brand text-white px-6 py-3 rounded-lg font-semibold hover:bg-brand-dark text-center">Gemeinde anmelden</a>
              <a href="/how-it-works" class="border border-ink/20 text-ink px-6 py-3 rounded-lg font-semibold hover:bg-white text-center">So funktioniert's</a>
            </div>
            <div class="mt-6 flex flex-wrap gap-2 text-xs">
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Eigene Subdomain</span>
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Gemeinde-Branding</span>
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Datenschutz (nDSG)</span>
              <span class="px-3 py-1 rounded-full bg-white/80 border border-slate-300/60">Kostenlos</span>
            </div>
          </div>
        </div>
      </div>

      <div class="relative">
        <div class="grid grid-cols-2 grid-rows-2 gap-3">
          <div class="col-span-1 row-span-2 overflow-hidden rounded-2xl border border-slate-200 shadow-lg">
            <img src="/static/images/landing/urban.png" alt="Urbaner Alltag" class="h-full w-full object-cover" loading="lazy">
          </div>
          <div class="overflow-hidden rounded-2xl border border-slate-200 shadow-lg">
            <img src="/static/images/landing/suburban.png" alt="Agglo Alltag" class="h-full w-full object-cover" loading="lazy">
          </div>
          <div class="overflow-hidden rounded-2xl border border-slate-200 shadow-lg">
            <img src="/static/images/landing/rural.png" alt="Ländlicher Alltag" class="h-full w-full object-cover" loading="lazy">
          </div>
        </div>
        <div class="mt-3 text-xs text-ink-muted">Stromgemeinschaften in Stadt, Agglo und auf dem Land.</div>
      </div>
    </div>
  </section>

  <!-- Proof Bar -->
  <section class="py-12 bg-[#f6f4ef]">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid md:grid-cols-4 gap-4">
        <div class="rounded-xl border border-slate-200 bg-white/80 p-4">
          <div class="text-sm text-ink-muted">Ihr Recht seit 1. Januar 2026</div>
          <div class="text-lg font-semibold">Lokale Stromgemeinschaft gründen</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white/80 p-4">
          <div class="text-sm text-ink-muted">Netzgebühren sparen</div>
          <div class="text-lg font-semibold">Bis 40% Rabatt in Ihrer LEG</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white/80 p-4">
          <div class="text-sm text-ink-muted">Smart Meter</div>
          <div class="text-lg font-semibold">Ihr Netzbetreiber installiert innert 3 Monaten</div>
        </div>
        <div class="rounded-xl border border-slate-200 bg-white/80 p-4">
          <div class="text-sm text-ink-muted">Plattform</div>
          <div class="text-lg font-semibold">Kostenlos, Open Source, Schweizer Hosting</div>
        </div>
      </div>
      <div class="mt-3 text-xs text-ink-muted">Rechtsgrundlage: Art. 17d/17e Stromversorgungsgesetz, Art. 19e-19h Stromversorgungsverordnung.</div>
    </div>
  </section>

  <!-- Gemeinde -->
  <section class="py-16 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h2 class="text-3xl font-bold">Für Gemeinden: die Energiewende vor Ort ermöglichen.</h2>
          <p class="text-ink-muted mt-3">Jede Gemeinde bekommt kostenlos ihre eigene Seite. Bewohner melden sich an, das System findet passende Nachbarn, Stromgemeinschaften entstehen.</p>
          <ul class="mt-4 space-y-2 text-ink-muted list-disc list-inside">
            <li>Eigene Webseite unter gemeinde.openleg.ch</li>
            <li>Automatisches Nachbarschafts-Matching</li>
            <li>Alle Dokumente: Vereinbarung, Verträge, Netzbetreiber-Anmeldung</li>
            <li>Fortschritt und Anmeldungen auf einen Blick</li>
          </ul>
          <a href="/fuer-gemeinden" class="inline-block mt-6 bg-brand text-white px-6 py-3 rounded-lg font-semibold hover:bg-brand-dark">Wie Ihre Gemeinde teilnimmt</a>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-amber-50 p-6">
          <div class="text-sm text-ink-muted">Kurz gesagt</div>
          <div class="mt-2 text-2xl font-semibold">In Tagen live, nicht in Monaten.</div>
          <div class="mt-3 text-ink-muted">Kostenlos. Kein IT Projekt. Kein Aufwand für Ihre Verwaltung. Wir übernehmen Technik und Betrieb.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Bewohner -->
  <section id="bewohner" class="py-16 bg-[#f6f4ef]">
    <div class="max-w-6xl mx-auto px-4">
      <div class="mb-6">
        <h2 class="text-3xl font-bold">Nachbarn finden, Stromgemeinschaft gründen</h2>
        <p class="text-ink-muted mt-2">Geben Sie Ihre Adresse ein und sehen Sie, wer in Ihrer Nähe ebenfalls mitmachen will. Alles anonymisiert, Ihre Daten bleiben bei Ihnen.</p>
        {% if user_count > 0 %}
        <p class="text-ink-muted mt-2">Bereits <strong class="text-ink">{{ user_count }}</strong> Haushalte registriert</p>
        {% endif %}
      </div>

      <div id="registrieren" class="grid md:grid-cols-2 gap-8">
        <!-- Map -->
        <div>
          <div id="map" class="w-full h-96 rounded-xl shadow-md z-0"></div>
          <p class="text-xs text-ink-muted mt-2">Registrierte Haushalte (anonymisiert, Standort um 120m versetzt)</p>
        </div>
        <!-- Form -->
        <div class="bg-white rounded-xl shadow-md p-6">
          <div id="step-address">
            <label class="block text-sm font-medium mb-1">Ihre Adresse</label>
            <input type="text" id="address-input" placeholder="Strasse, PLZ Ort" class="w-full border rounded-lg px-3 py-2 mb-1 focus:ring-2 focus:ring-brand focus:outline-none" autocomplete="off">
            <div id="suggestions" class="bg-white border rounded-lg max-h-48 overflow-y-auto hidden"></div>
            <div id="profile-summary" class="text-sm text-ink-muted mt-2 hidden"></div>
            <button id="btn-check" class="w-full bg-brand text-white py-2 rounded-lg mt-3 font-medium hover:bg-brand-dark disabled:opacity-50" disabled>Adresse prüfen</button>
          </div>
          <div id="step-register" class="hidden">
            <div id="match-info" class="bg-indigo-50 p-3 rounded-lg mb-3 text-sm"></div>
            <label class="block text-sm font-medium mb-1">E-Mail</label>
            <input type="email" id="email-input" placeholder="ihre@email.ch" class="w-full border rounded-lg px-3 py-2 mb-2 focus:ring-2 focus:ring-brand focus:outline-none">
            <label class="block text-sm font-medium mb-1">Telefon (optional)</label>
            <input type="tel" id="phone-input" placeholder="+41 79 ..." class="w-full border rounded-lg px-3 py-2 mb-3 focus:ring-2 focus:ring-brand focus:outline-none">
            <div class="space-y-2 mb-4 text-sm">
              <label class="flex items-start gap-2"><input type="checkbox" id="consent-neighbors" class="mt-1"> Ich möchte, dass interessierte Nachbarn in meiner Nähe mich kontaktieren können.</label>
              <label class="flex items-start gap-2"><input type="checkbox" id="consent-utility" class="mt-1"> Meine Daten dürfen für die LEG-Anmeldung beim Netzbetreiber verwendet werden.</label>
              <label class="flex items-start gap-2"><input type="checkbox" id="consent-updates"> Ich möchte Updates per E-Mail erhalten.</label>
            </div>
            <p class="text-xs text-ink-muted mb-3">Ihre Daten werden nicht verkauft und nicht an Dritte weitergegeben. Sie können jederzeit alles löschen.</p>
            <button id="btn-register" class="w-full bg-amber-500 text-ink py-2 rounded-lg font-semibold hover:bg-amber-400">Jetzt registrieren</button>
          </div>
          <div id="step-success" class="hidden text-center py-6">
            <div class="text-4xl mb-3">&#9889;</div>
            <h3 class="text-lg font-semibold mb-2">Registrierung erfolgreich!</h3>
            <p class="text-ink-muted mb-4">Sie erhalten eine Bestätigung per E-Mail.</p>
            <div id="referral-link-box" class="bg-gray-50 p-3 rounded-lg text-sm hidden">
              <p class="font-medium mb-1">Teilen Sie Ihren Einladungslink:</p>
              <input type="text" id="referral-link" class="w-full border rounded px-2 py-1 text-xs" readonly>
            </div>
          </div>
          <div id="form-error" class="text-red-600 text-sm mt-2 hidden"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Open Source / Mission -->
  <section class="py-16 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid md:grid-cols-2 gap-10 items-center">
        <div>
          <h2 class="text-3xl font-bold">Open Source. Weil Energieinfrastruktur allen gehört.</h2>
          <p class="text-ink-muted mt-3">OpenLEG ist freie Software. Der gesamte Code ist öffentlich einsehbar, jede Gemeinde kann die Plattform selbst betreiben, und niemand kontrolliert Ihre Energiedaten.</p>
          <ul class="mt-4 space-y-2 text-ink-muted list-disc list-inside">
            <li>Gesamter Code auf GitHub, AGPL-3.0 Lizenz</li>
            <li>Freie API für Schweizer Energiedaten (ElCom Tarife, Sonnendach, Energie Reporter)</li>
            <li>Kein Vendor Lock-in: jederzeit selbst hosten oder migrieren</li>
            <li>Community-Beiträge willkommen</li>
          </ul>
          <a href="https://github.com/openleg/openleg" target="_blank" rel="noopener" class="inline-block mt-6 border border-ink/20 text-ink px-6 py-3 rounded-lg font-semibold hover:bg-slate-50">Code auf GitHub ansehen</a>
        </div>
        <div class="space-y-4">
          <div class="rounded-xl border border-slate-200 bg-[#f6f4ef] p-5">
            <div class="font-semibold">Freie Energiedaten API</div>
            <p class="text-sm text-ink-muted mt-1">ElCom Tarife, Solarpotenzial, Gemeinde-Profile für alle 2'131 Schweizer Gemeinden. Kein API-Key nötig.</p>
            <a href="/api/v1/docs" class="text-sm text-brand mt-2 inline-block">API Dokumentation</a>
          </div>
          <div class="rounded-xl border border-slate-200 bg-[#f6f4ef] p-5">
            <div class="font-semibold">Datenhoheit</div>
            <p class="text-sm text-ink-muted mt-1">Ihre Smart-Meter-Daten bleiben in Ihrer Stromgemeinschaft. Wir verkaufen keine Daten an Energieversorger oder Dritte.</p>
          </div>
          <div class="rounded-xl border border-slate-200 bg-[#f6f4ef] p-5">
            <div class="font-semibold">Schweizer Hosting</div>
            <p class="text-sm text-ink-muted mt-1">Betrieben auf Schweizer Infrastruktur (Infomaniak), konform mit dem Schweizer Datenschutzgesetz (nDSG).</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  {% include 'partials/site_footer.html' %}

  <script src="/static/js/landing_segments.js"></script>

  <script>
  // Map
  const map = L.map('map').setView([{{ map_center_lat }}, {{ map_center_lon }}], {{ map_zoom }});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let selectedProfile = null;
  let addressTimeout = null;

  // Address autocomplete
  const addressInput = document.getElementById('address-input');
  const suggestionsDiv = document.getElementById('suggestions');
  const btnCheck = document.getElementById('btn-check');

  addressInput.addEventListener('input', function() {
      clearTimeout(addressTimeout);
      const q = this.value.trim();
      if (q.length < 3) { suggestionsDiv.classList.add('hidden'); return; }
      addressTimeout = setTimeout(async () => {
          const res = await fetch(`/api/suggest_addresses?q=${encodeURIComponent(q)}`);
          const data = await res.json();
          if (data.suggestions && data.suggestions.length > 0) {
              suggestionsDiv.innerHTML = data.suggestions.map(s =>
                  `<div class="px-3 py-2 hover:bg-indigo-50 cursor-pointer text-sm border-b" data-lat="${s.lat}" data-lon="${s.lon}" data-plz="${s.plz}" data-label="${s.label}">${s.label}</div>`
              ).join('');
              suggestionsDiv.classList.remove('hidden');
              suggestionsDiv.querySelectorAll('div').forEach(el => {
                  el.addEventListener('click', function() {
                      addressInput.value = this.dataset.label;
                      suggestionsDiv.classList.add('hidden');
                      btnCheck.disabled = false;
                  });
              });
          } else {
              suggestionsDiv.classList.add('hidden');
          }
      }, 300);
  });

  // Check potential
  btnCheck.addEventListener('click', async function() {
      this.disabled = true;
      this.textContent = 'Prüfe...';
      document.getElementById('form-error').classList.add('hidden');
      try {
          const res = await fetch('/api/check_potential', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({address: addressInput.value})
          });
          const data = await res.json();
          if (data.error) {
              document.getElementById('form-error').textContent = data.error;
              document.getElementById('form-error').classList.remove('hidden');
              this.disabled = false;
              this.textContent = 'Adresse prüfen';
              return;
          }
          selectedProfile = data.profile_summary;
          const matchInfo = document.getElementById('match-info');
          if (data.potential) {
              const ci = data.cluster_info;
              matchInfo.innerHTML = `<strong>${ci.num_members} Nachbarn gefunden!</strong> Autarkie-Potenzial: ${ci.autarky_percent.toFixed(0)}%`;
          } else {
              matchInfo.innerHTML = '<strong>Noch keine Nachbarn gefunden.</strong> Sie können trotzdem registrieren.';
          }
          document.getElementById('step-address').classList.add('hidden');
          document.getElementById('step-register').classList.remove('hidden');
      } catch(e) {
          document.getElementById('form-error').textContent = 'Netzwerkfehler. Bitte erneut versuchen.';
          document.getElementById('form-error').classList.remove('hidden');
          this.disabled = false;
          this.textContent = 'Adresse prüfen';
      }
  });

  // Register
  document.getElementById('btn-register').addEventListener('click', async function() {
      const email = document.getElementById('email-input').value;
      const phone = document.getElementById('phone-input').value;
      const cn = document.getElementById('consent-neighbors').checked;
      const cu = document.getElementById('consent-utility').checked;
      const co = document.getElementById('consent-updates').checked;
      if (!email) {
          document.getElementById('form-error').textContent = 'Bitte E-Mail angeben.';
          document.getElementById('form-error').classList.remove('hidden');
          return;
      }
      try {
          const res = await fetch('/api/register_interest', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                  email, phone, profile_summary: selectedProfile,
                  consents: {share_with_neighbors: cn, share_with_utility: cu, updates_opt_in: co}
              })
          });
          const data = await res.json();
          if (data.success) {
              document.getElementById('step-register').classList.add('hidden');
              document.getElementById('step-success').classList.remove('hidden');
              if (data.referral_link) {
                  document.getElementById('referral-link').value = data.referral_link;
                  document.getElementById('referral-link-box').classList.remove('hidden');
              }
          } else {
              document.getElementById('form-error').textContent = data.error || 'Registrierung fehlgeschlagen.';
              document.getElementById('form-error').classList.remove('hidden');
          }
      } catch(e) {
          document.getElementById('form-error').textContent = 'Netzwerkfehler.';
          document.getElementById('form-error').classList.remove('hidden');
      }
  });
  </script>
</body>
</html>
